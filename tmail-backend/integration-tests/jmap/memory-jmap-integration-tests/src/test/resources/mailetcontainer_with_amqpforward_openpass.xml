<?xml version="1.0"?>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ~  As a subpart of Twake Mail, this file is edited by Linagora.   ~
  ~                                                                 ~
  ~  https://twake-mail.com/                                        ~
  ~  https://linagora.com                                           ~
  ~                                                                 ~
  ~  This file is subject to The Affero Gnu Public License          ~
  ~  version 3.                                                     ~
  ~                                                                 ~
  ~  https://www.gnu.org/licenses/agpl-3.0.en.html                  ~
  ~                                                                 ~
  ~  This program is distributed in the hope that it will be        ~
  ~  useful, but WITHOUT ANY WARRANTY; without even the implied     ~
  ~  warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR        ~
  ~  PURPOSE. See the GNU Affero General Public License for         ~
  ~  more details.                                                  ~
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->

<mailetcontainer enableJmx="false">

    <context>
        <postmaster>postmaster</postmaster>
    </context>

    <spooler>
        <threads>20</threads>
        <errorRepository>memory://var/mail/error/</errorRepository>
    </spooler>

    <processors>
        <processor state="root" enableJmx="false">
            <mailet match="All" class="PostmasterAlias"/>
            <mailet match="RelayLimit=30" class="Null"/>
            <mailet match="All" class="ToProcessor">
                <processor>transport</processor>
            </mailet>
        </processor>

        <processor state="error" enableJmx="false">
            <mailet match="All" class="Bounce"/>
            <mailet match="All" class="ToRepository">
                <repositoryPath>memory://var/mail/error/</repositoryPath>
            </mailet>
        </processor>

        <processor state="transport" enableJmx="false">
            <mailet match="SMTPAuthSuccessful" class="SetMimeHeader">
                <name>X-UserIsAuth</name>
                <value>true</value>
            </mailet>
            <mailet match="All" class="RemoveMimeHeader">
                <name>bcc</name>
            </mailet>
            <!-- ICAL pipeline for EventCaleandar response -->
            <mailet match="SenderIsLocal" class="StripAttachment">
                <mimeType>text/calendar</mimeType>
                <attribute>rawIcalendar2</attribute>
                <onMailetException>ignore</onMailetException>
            </mailet>
            <mailet match="SenderIsLocal" class="MimeDecodingMailet">
                <attribute>rawIcalendar2</attribute>
                <onMailetException>ignore</onMailetException>
            </mailet>
            <mailet match="SenderIsLocal" class="ICalendarParser">
                <sourceAttribute>rawIcalendar2</sourceAttribute>
                <destinationAttribute>icalendar2</destinationAttribute>
                <onMailetException>ignore</onMailetException>
            </mailet>
            <mailet match="SenderIsLocal" class="com.linagora.tmail.mailet.SenderICALToJsonAttribute">
                <source>icalendar2</source>
                <destination>icalendarAsJson2</destination>
                <rawSource>rawIcalendar2</rawSource>
                <onMailetException>ignore</onMailetException>
            </mailet>
            <mailet match="SenderIsLocal" class="com.linagora.tmail.mailet.OpenPaasAmqpForwardAttribute">
                <attribute>icalendarAsJson2</attribute>
                <exchange>james:events</exchange>
                <exchange_type>fanout</exchange_type>
                <routing_key>icalendar_routing_key2</routing_key>
            </mailet>
            <!-- End of ICAL pipeline -->
            <mailet match="All" class="RecipientRewriteTable">
                <errorProcessor>rrt-error</errorProcessor>
            </mailet>
            <mailet match="RecipientIsLocal" class="ToProcessor">
                <processor>local-delivery</processor>
            </mailet>
            <mailet match="HostIsLocal" class="ToProcessor">
                <processor>local-address-error</processor>
                <notice>550 - Requested action not taken: no such user here</notice>
            </mailet>
            <mailet match="SMTPAuthSuccessful" class="SetMailAttribute">
                <RelayAllowed>true</RelayAllowed>
            </mailet>
            <mailet match="SMTPIsAuthNetwork" class="SetMailAttribute">
                <RelayAllowed>true</RelayAllowed>
            </mailet>
            <mailet match="SentByMailet" class="SetMailAttribute">
                <RelayAllowed>true</RelayAllowed>
            </mailet>
            <mailet match="org.apache.james.jmap.mailet.SentByJmap" class="SetMailAttribute">
                <RelayAllowed>true</RelayAllowed>
            </mailet>
            <mailet match="HasMailAttribute=RelayAllowed" class="RemoteDelivery">
                <outgoingQueue>outgoing</outgoingQueue>
                <delayTime>5000, 100000, 500000</delayTime>
                <maxRetries>3</maxRetries>
                <maxDnsProblemRetries>0</maxDnsProblemRetries>
                <deliveryThreads>10</deliveryThreads>
                <sendpartial>true</sendpartial>
                <bounceProcessor>bounces</bounceProcessor>
            </mailet>
            <mailet match="All" class="ToProcessor">
                <processor>relay-denied</processor>
            </mailet>
        </processor>

        <processor state="local-delivery" enableJmx="true">
            <mailet match="All" class="VacationMailet"/>
            <mailet match="All" class="Sieve"/>
            <mailet match="All" class="AddDeliveredToHeader"/>
            <mailet match="All" class="org.apache.james.jmap.mailet.filter.JMAPFiltering"/>
            <mailet match="SenderIsLocal" class="ContactExtractor">
                <attribute>ContactAttribute1</attribute>
            </mailet>
            <mailet match="SenderIsLocal" class="com.linagora.tmail.mailets.IndexContacts">
                <attribute>ContactAttribute1</attribute>
            </mailet>
            <mailet match="All" class="com.linagora.tmail.mailets.TmailLocalDelivery"/>
        </processor>

        <processor state="spam" enableJmx="false">
            <mailet match="All" class="ToRepository">
                <repositoryPath>memory://var/mail/spam/</repositoryPath>
            </mailet>
        </processor>

        <processor state="local-address-error" enableJmx="false">
            <mailet match="All" class="Bounce">
                <attachment>none</attachment>
            </mailet>
            <mailet match="All" class="ToRepository">
                <repositoryPath>memory://var/mail/address-error/</repositoryPath>
            </mailet>
        </processor>

        <processor state="relay-denied" enableJmx="false">
            <mailet match="All" class="Bounce">
                <attachment>none</attachment>
            </mailet>
            <mailet match="All" class="ToRepository">
                <repositoryPath>memory://var/mail/relay-denied/</repositoryPath>
                <notice>Warning: You are sending an e-mail to a remote server. You must be authentified to perform such an operation</notice>
            </mailet>
        </processor>

        <processor state="bounces" enableJmx="false">
            <mailet match="All" class="DSNBounce">
                <passThrough>false</passThrough>
            </mailet>
        </processor>

        <processor state="rrt-error" enableJmx="false">
            <mailet match="All" class="ToRepository">
                <repositoryPath>memory://var/mail/rrt-error/</repositoryPath>
                <passThrough>true</passThrough>
            </mailet>
            <mailet match="IsSenderInRRTLoop" class="Null"/>
            <mailet match="All" class="Bounce"/>
        </processor>

    </processors>

</mailetcontainer>


