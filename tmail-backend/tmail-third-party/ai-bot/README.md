# AIBot third party

We provide a mailet extension for OpenAI-compatible APIs integration. The goal is to provide a mail bot at e.g. `gpt@example.com` that replies to users' questions.

## Requirements

Before getting started, make sure you have:
1. **An OpenAI-compatible API** with:
   - A valid API key
   - An API endpoint URL
2. **A suitable LLM model** for your use case

## Configuration Files

### API configuration

All settings are centralized in the `ai.properties` file, to be placed into the `/root/conf/` directory.

Sample `ai.properties` configuration:
```properties
apiKey=demo
botAddress=gpt@example.com
model=lucie
baseURL=https://chat.lucie.example.com
```

**Parameter explanation:**

* `apiKey`: The API key for accessing the LLM API service.
* `botAddress`: The email address used to send replies generated by the LLM.
* `baseURL`: The URL of an LLM API compatible with OpenAI, e.g. https://ai.linagora.com/api. If left blank, defaults to the official OpenAI API base URL.
* `model`: Identifier of the LLM that generates the replies. Defaults to `gpt-4o-mini`.

You can use the langchain4j demo API at http://langchain4j.dev/demo/openai/v1 with the `gpt-4o-mini` model and `demo` API key for testing purposes.

#### Sanity check

Verify your configuration with the following command:

```bash
curl <baseURL>/chat/completions \
  -H "Authorization: Bearer <apiKey>" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "<model>",
    "messages": [
      {
        "role": "system",
        "content": "You are a helpful assistant."
      },
      {
        "role": "user",
        "content": "Why is the sky blue?"
      }
    ]
  }'
```

### Mailet configuration

Modify the `mailetcontainer.xml` file by adding the following lines:

```xml
<processor state="local-delivery" enableJmx="true">
    ...
    <mailet match="All" class="com.linagora.tmail.mailets.TmailLocalDelivery">
        <consume>false</consume>
    </mailet>
    <!-- Put the AIBotMailet after LocalDelivery so the GPT reply would come after the asking question -->
    <mailet match="com.linagora.tmail.mailet.RecipientsContain={your bot address here}"
            class="com.linagora.tmail.mailet.AIBotMailet"/>
</processor>
```

## Starting the AIBot

###  Clean Install (In-Memory)

The following steps will start the AIBot extension in memory.

1. **Compile the extension**

    Build the extension JAR with Maven:

    ```bash
    mvn clean install -DskipTests --am --pl :tmail-ai-bot
    ```

2. **Plug the extension in your TMail application**

      - Copy the generated JAR `target/tmail-ai-bot-jar-with-dependencies.jar` in the `/root/libs/` directory of your TMail application.
      - Declare the plugin in the `extensions.properties` file
          ```bash
          guice.extension.module=com.linagora.tmail.mailet.conf.AIBotModule,com.linagora.tmail.jmap.aibot.AiBotMethodModule
          ```

3. **Run the server**

    Use the following Docker command to run AIBot in memory. Make sure that you have modified the configuration files in the `sample_conf/` directory before running:

    ```bash
    docker run \
      --mount type=bind,source="$PWD/sample_conf/jwt_publickey",target="/root/conf/jwt_publickey" \
      --mount type=bind,source="$PWD/sample_conf/jwt_privatekey",target="/root/conf/jwt_privatekey" \
      --mount type=bind,source="$PWD/sample_conf/mailetcontainer.xml",target="/root/conf/mailetcontainer.xml" \
      --mount type=bind,source="$PWD/sample_conf/ai.properties",target="/root/conf/ai.properties" \
      --mount type=bind,source="$PWD/sample_conf/extensions.properties",target="/root/conf/extensions.properties" \
      --volume "$PWD/target/tmail-ai-bot-jar-with-dependencies.jar:/root/libs/tmail-ai-bot-jar-with-dependencies.jar" \
      linagora/tmail-backend-memory
    ```

### With the demo server

You can test the AIBot extension with the demo server.

Sample configuration files are located in the `demo/tmail` directory. Modify these files as needed, and proceed with the [demo instructions](../../../demo/README.md).

# Troubleshooting

## No response received

1. [Verify your configuration](#sanity-check)
2. Make sure the same bot address is used in the mailet configuration and in the properties file

## API quota issues

Demo APIs often have usage quotas. Ensure your requests are not being rate limited due to heavy usage or automated scripts.