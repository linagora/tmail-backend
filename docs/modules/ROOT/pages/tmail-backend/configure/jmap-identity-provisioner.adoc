== JMAP Identity Provision Listener
:navtitle: JMAP identity provision listener

This listener will automatically provision a default JMAP identity for a user when their mailbox is first created.
It avoids the need to rely on the external LSC synchronisation job to populate user JMAP identities.

When a new user’s mailbox (INBOX) is created, this listener will:
- Look up the user’s personal information (first name, surname) directly from LDAP.
- Create a default JMAP identity for the user, using these attributes.

This ensures that users can immediately send emails with their proper display name without waiting for any background synchronisation.

It is possible to configure LDAP lookup parameters such as attribute names used to retrieve the user’s first and last names:
- `firstnameAttribute`: attribute to get firstname of user from LDAP. Default to `givenName`.
- `surnameAttribute`: attribute to get surname of user from LDAP. Default to `sn`.
- `extraAttributes`: comma-separated list of additional LDAP attribute names to fetch. These attributes can then be referenced in signature templates using the `+{ldap:attributeName}+` placeholder syntax (see below).

We can configure to provision i18n signatures by defining `defaultText` in the listener configuration.
If `defaultText` is not configured, this listener provisions no signature.
If `defaultText` is configured, signature provisioning is applied.

Configuration keys:
- `defaultText.applyWhen`: optional `ApplyWhenFilter` implementation FQDN class name. It is loaded via Guice Loader. If not configured, it defaults to an always-eligible filter.
- `defaultText.defaultLanguage`: fallback language (defaults to `en` when omitted).
- `defaultText.<locale>.textSignature`: plain-text signature for a locale.
- `defaultText.<locale>.htmlSignature`: HTML signature for a locale.

Signature templates support LDAP attribute interpolation using the `+{ldap:attributeName}+` placeholder syntax.
When provisioning an identity, placeholders are replaced with the corresponding LDAP attribute value fetched for that user.
`givenName`, `sn`, and the username attribute are always fetched. Additional attributes must be declared via `extraAttributes`.
If an attribute placeholder references an attribute that was not fetched or has no value, the placeholder is left as-is.

Example: `+{ldap:givenName} {ldap:sn}+` becomes `John Doe`.

Notes:
- If `defaultText` is not configured, no i18n signature is provisioned.
- Locale keys and `defaultText.defaultLanguage` must be valid locales.
- `defaultText.defaultLanguage` must match one configured locale block.

Sample configuration: `listeners.xml`

[source,xml]
----
<listeners>
  <listener>
    <class>com.linagora.tmail.james.jmap.event.IdentityProvisionListener</class>
    <configuration>
      <firstnameAttribute>givenName</firstnameAttribute>
      <surnameAttribute>sn</surnameAttribute>
      <!-- Optional: fetch additional LDAP attributes for use in signature templates -->
      <extraAttributes>telephoneNumber,title</extraAttributes>
      <defaultText>
        <defaultLanguage>en</defaultLanguage>
        <en>
          <textSignature><![CDATA[Best regards,
{ldap:title} {ldap:givenName} {ldap:sn}
{ldap:telephoneNumber}]]></textSignature>
          <htmlSignature><![CDATA[<p>Best regards,<br/>{ldap:title} {ldap:givenName} {ldap:sn}<br/>{ldap:telephoneNumber}</p>]]></htmlSignature>
        </en>
      </defaultText>
    </configuration>
  </listener>
</listeners>
----

=== SaaS Signature Enrichment

For SaaS context, we can use the `applyWhen` filter to scope signature provisioning to only non-paying users.
Use `<applyWhen>com.linagora.tmail.saas.filter.SaaSNonPayingUser</applyWhen>`.

