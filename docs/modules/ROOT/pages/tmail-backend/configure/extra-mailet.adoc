= Extra Mailets
:navtitle: Extra Mailets

This page documents additional mailets provided by TMail for specific use cases.

== AlignFromHeaderWithMailFrom

=== Purpose

The `AlignFromHeaderWithMailFrom` mailet rewrites the `From` header to align with the envelope sender (MAIL FROM) address. This is particularly useful for email forwarding scenarios to preserve DKIM alignment and avoid spam filter issues.

When emails are forwarded, the envelope sender (MAIL FROM) is typically rewritten to the forwarder's address, but the `From` header remains unchanged. This creates a DKIM alignment mismatch that can trigger spam filters. This mailet solves this problem by aligning both addresses.

Use cases:

* *Email forwarding*: When implementing email forwarding services to maintain DKIM alignment
* *Email aliasing*: When routing emails through aliases while preserving sender information
* *Mailing lists*: When forwarding list emails while maintaining proper email authentication

=== How it works

The mailet performs the following transformations:

1. Extracts the original `From` header address and display name
2. Stores the original email address in an `Original-From` header
3. Rewrites the `From` header to use the MAIL FROM address
4. Preserves the original sender information in the display name

*Example transformation:*

Original:

....
MAIL FROM: alice@us.com
From: "Bob External" <bob@external.com>
....

After transformation:

....
MAIL FROM: alice@us.com
From: "Bob External (bob@external.com)" <alice@us.com>
Original-From: bob@external.com
....

=== Configuration

==== Parameters

[cols="1,1,3", options="header"]
|===
|Parameter
|Default
|Description

|misAlignProcessor
|error
|The processor to which mails with unparseable or missing From headers will be redirected for error handling.
|===

==== Usage with DKIM signature stripping

To achieve proper DKIM alignment for forwarded emails, it's recommended to strip existing DKIM signatures before running this mailet. Use the `RemoveMimeHeader` mailet for this purpose.

*Sample configuration:*

....
<mailet match="All" class="com.linagora.tmail.mailet.AlignFromHeaderWithMailFrom">
  <misAlignProcessor>error</misAlignProcessor>
</mailet>
....

== Sampling

=== Purpose

The `Sampling` matcher randomly matches a percentage of emails based on a probability parameter. This matcher enables probabilistic email routing for traffic management and reputation control.

Use cases:

* *Traffic distribution*: Evenly divide outgoing mail across multiple gateways to enhance email deliverability rates
* *Reputation management*: Enable gradual warming up of sending reputation through controlled traffic distribution
* *A/B testing*: Route a percentage of emails through different processing pipelines for testing purposes
* *Load balancing*: Distribute email processing load across multiple systems

=== How it works

The matcher uses a random number generator to determine whether each email should match based on the configured sampling rate. Each email is independently evaluated, ensuring a statistically even distribution over time.

The sampling rate is specified as a decimal value between 0.0 and 1.0:

* `0.0` = 0% (no emails match)
* `0.01` = 1% of emails match
* `0.5` = 50% of emails match
* `1.0` = 100% (all emails match)

=== Configuration

==== Parameters

The matcher accepts a single parameter: the sampling rate as a decimal value.

[cols="1,1,3", options="header"]
|===
|Parameter
|Required
|Description

|rate
|Yes
|A decimal value between 0.0 and 1.0 representing the probability that an email will match. For example, 0.01 means approximately 1% of emails will be matched.
|===

==== Basic usage

*Sample configuration for 1% sampling:*

....
<mailet match="Sampling=0.01" class="RemoteDelivery">
  <gateway>smtp-gateway-1.example.com</gateway>
</mailet>
....

==== Traffic distribution example

To distribute traffic across multiple gateways for better deliverability:

....
<!-- 50% of emails go through gateway 1 -->
<mailet match="Sampling=0.5" class="RemoteDelivery">
  <gateway>smtp-gateway-1.example.com</gateway>
</mailet>

<!-- Remaining emails go through gateway 2 -->
<mailet match="All" class="RemoteDelivery">
  <gateway>smtp-gateway-2.example.com</gateway>
</mailet>
....

==== Gradual reputation warming

To gradually increase sending volume when warming up a new IP address:

....
<!-- Week 1: Send only 10% of emails through new IP -->
<mailet match="Sampling=0.1" class="RemoteDelivery">
  <gateway>new-smtp-gateway.example.com</gateway>
</mailet>

<!-- Remaining emails through established IP -->
<mailet match="All" class="RemoteDelivery">
  <gateway>established-smtp-gateway.example.com</gateway>
</mailet>
....
