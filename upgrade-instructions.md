# Upgrade instructions

This document covers every changes an Ops needs to be aware of when running Twake Mail backend mail server.

The following procedures are to take as it, and Linagora, nor its contributors, can not be 
responsible for any damages generated by following the below procedures.

Before performing these operations, you should ensure to have the skills to conduct the operations, and you should read other
software documentation. Do not follow this guide blindly!

## Unreleased

Note: this section is in progress. It will be updated during all the development process until the release.

- [Set up TTL on the mailbox_change and email_change tables](#set-up-ttl-on-the-mailboxchange-and-emailchange-tables)

### Set up TTL on the label_change table
Date: 15/09/2023

JIRA: https://issues.apache.org/jira/browse/JAMES-3940

Concerned products: Distributed James, Distributed James ESv6

From now on, we set a default 60 days (configurable) Cassandra time-to-live on the `label_change` table
to reduce considered outdated changes' storage usage.

If one want to keep the old behavior which is not using Cassandra time-to-live on those JMAP change tables, please set the
following configurations in `cassandra.properties`:

```
label.change.ttl=0 second
```

## 0.6.5-rc2 version

Change list:

- [Autocomplete should support normalizing language special characters](#autocomplete-should-support-normalizing-language-special-characters)

### Autocomplete should support normalizing language special characters

Date 14/12/2022

Ticket: https://github.com/linagora/tmail-backend/issues/534

Concerned product: Distributed Twake Mail, Distributed ES6 Twake Mail

We changed an analyzer setting for `user` and `domain` autocomplete indexes, therefore we need to reindex these two indexes
to make the new analyzer applies for existing documents.

We need to perform reindexing with aliases for zero downtime as we normally did.

New indexes settings + mapping (pay attention to change some `change-me` values - could get those values by getting the old indexes' settings):

#### Distributed Twake Mail (OpenSearch)

- new `user` contact index:

```
{
	"settings": {
		"number_of_shards": change-me,
		"number_of_replicas": change-me,
		"index.write.wait_for_active_shards": change-me,
		"index": {
			"max_ngram_diff": change-me
		},
		"analysis": {
			"analyzer": {
				"email_ngram_filter_analyzer": {
					"tokenizer": "uax_url_email",
					"filter": ["ngram_filter", "lowercase"]
				},
				"name_edge_ngram_filter_analyzer": {
					"tokenizer": "standard",
					"filter": ["edge_ngram_filter", "lowercase", "preserved_ascii_folding_filter"]
				},
				"rebuilt_keyword": {
					"tokenizer": "keyword",
					"filter": ["lowercase"]
				}
			},
			"filter": {
				"ngram_filter": {
					"type": "ngram",
					"min_gram": change-me,
					"max_gram": change-me
				},
				"edge_ngram_filter": {
					"type": "edge_ngram",
					"min_gram": change-me,
					"max_gram": change-me
				},
				"preserved_ascii_folding_filter": {
					"type": "asciifolding",
					"preserve_original": true
				}
			}
		}
	},
	"mappings": {
		"properties": {
			"accountId": {
				"type": "keyword"
			},
			"contactId": {
				"type": "keyword"
			},
			"email": {
				"type": "text",
				"analyzer": "email_ngram_filter_analyzer",
				"search_analyzer": "rebuilt_keyword"
			},
			"firstname": {
				"type": "text",
				"analyzer": "name_edge_ngram_filter_analyzer",
				"search_analyzer": "standard"
			},
			"surname": {
				"type": "text",
				"analyzer": "name_edge_ngram_filter_analyzer",
				"search_analyzer": "standard"
			}
		}
	}
}
```

- new `domain` contact index:

```
{
	"settings": {
		"number_of_shards": change-me,
		"number_of_replicas": change-me,
		"index.write.wait_for_active_shards": change-me,
		"index": {
			"max_ngram_diff": change-me
		},
		"analysis": {
			"analyzer": {
				"email_ngram_filter_analyzer": {
					"tokenizer": "uax_url_email",
					"filter": ["ngram_filter", "lowercase"]
				},
				"name_edge_ngram_filter_analyzer": {
					"tokenizer": "standard",
					"filter": ["edge_ngram_filter", "lowercase", "preserved_ascii_folding_filter"]
				},
				"rebuilt_keyword": {
					"tokenizer": "keyword",
					"filter": ["lowercase"]
				}
			},
			"filter": {
				"ngram_filter": {
					"type": "ngram",
					"min_gram": change-me,
					"max_gram": change-me
				},
				"edge_ngram_filter": {
					"type": "edge_ngram",
					"min_gram": change-me,
					"max_gram": change-me
				},
				"preserved_ascii_folding_filter": {
					"type": "asciifolding",
					"preserve_original": true
				}
			}
		}
	},
	"mappings": {
		"properties": {
			"domain": {
				"type": "keyword"
			},
			"contactId": {
				"type": "keyword"
			},
			"email": {
				"type": "text",
				"analyzer": "email_ngram_filter_analyzer",
				"search_analyzer": "rebuilt_keyword"
			},
			"firstname": {
				"type": "text",
				"analyzer": "name_edge_ngram_filter_analyzer",
				"search_analyzer": "standard"
			},
			"surname": {
				"type": "text",
				"analyzer": "name_edge_ngram_filter_analyzer",
				"search_analyzer": "standard"
			}
		}
	}
}
```

#### Distributed ES6 Twake Mail (Elasticsearch v6)

- new `user` contact index:

```
{
  "settings": {
    "number_of_shards": change-me,
    "number_of_replicas": change-me,
    "index.write.wait_for_active_shards": change-me,
    "analysis": {
      "analyzer": {
        "email_ngram_filter_analyzer": {
          "tokenizer": "uax_url_email",
          "filter": ["ngram_filter", "lowercase"]
        },
        "name_edge_ngram_filter_analyzer": {
          "tokenizer": "standard",
          "filter": ["edge_ngram_filter", "lowercase", "preserved_ascii_folding_filter"]
        },
        "rebuilt_keyword": {
          "tokenizer": "keyword",
          "filter": ["lowercase"]
        }
      },
      "filter": {
        "ngram_filter": {
          "type": "ngram",
          "min_gram": change-me,
          "max_gram": change-me
        },
        "edge_ngram_filter": {
          "type": "edge_ngram",
          "min_gram": change-me,
          "max_gram": change-me
        },
        "preserved_ascii_folding_filter": {
          "type": "asciifolding",
          "preserve_original": true
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "accountId": {
        "type": "keyword"
      },
      "contactId": {
        "type": "keyword"
      },
      "email": {
        "type": "text",
        "analyzer": "email_ngram_filter_analyzer",
        "search_analyzer": "rebuilt_keyword"
      },
      "firstname": {
        "type": "text",
        "analyzer": "name_edge_ngram_filter_analyzer",
        "search_analyzer": "standard"
      },
      "surname": {
        "type": "text",
        "analyzer": "name_edge_ngram_filter_analyzer",
        "search_analyzer": "standard"
      }
    }
  }
}
```

- new `domain` contact index:

```
{
  "settings": {
    "number_of_shards": change-me,
    "number_of_replicas": change-me,
    "index.write.wait_for_active_shards": change-me,
    "analysis": {
      "analyzer": {
        "email_ngram_filter_analyzer": {
          "tokenizer": "uax_url_email",
          "filter": ["ngram_filter", "lowercase"]
        },
        "name_edge_ngram_filter_analyzer": {
          "tokenizer": "standard",
          "filter": ["edge_ngram_filter", "lowercase", "preserved_ascii_folding_filter"]
        },
        "rebuilt_keyword": {
          "tokenizer": "keyword",
          "filter": ["lowercase"]
        }
      },
      "filter": {
        "ngram_filter": {
          "type": "ngram",
          "min_gram": change-me,
          "max_gram": change-me
        },
        "edge_ngram_filter": {
          "type": "edge_ngram",
          "min_gram": change-me,
          "max_gram": change-me
        },
        "preserved_ascii_folding_filter": {
          "type": "asciifolding",
          "preserve_original": true
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "domain": {
        "type": "keyword"
      },
      "contactId": {
        "type": "keyword"
      },
      "email": {
        "type": "text",
        "analyzer": "email_ngram_filter_analyzer",
        "search_analyzer": "rebuilt_keyword"
      },
      "firstname": {
        "type": "text",
        "analyzer": "name_edge_ngram_filter_analyzer",
        "search_analyzer": "standard"
      },
      "surname": {
        "type": "text",
        "analyzer": "name_edge_ngram_filter_analyzer",
        "search_analyzer": "standard"
      }
    }
  }
}
```

## 0.6.3 version

Change list:

- [Improve indexing of email address domains](#improve-indexing-of-email-address-domains)

### Improve indexing of email address domains

Date 04/10/2022

JIRA: https://issues.apache.org/jira/browse/JAMES-3827

Concerned product: Distributed Twake Mail, Distributed ES6 Twake Mail

#### Distributed Twake Mail
If you did not finish reindexing data as part of [OpenSearch Migration](https://github.com/apache/james-project/blob/0600e060b9406f58cf8b483d03f1109c7686a82d/upgrade-instructions.md#migration-to-opensearch), 
you can skip this instruction and just reindex data. 

Otherwise, please add these fields to the mailbox mapping manually:

```
curl -X PUT \
  http://OSip:OSport/{$mailboxIndexName}/_mapping \
  -H 'Content-Type: application/json' \
  -d '{
  "properties": {
    "from": {
      "properties": {
        "domain": {
          "type": "text",
          "analyzer": "simple",
          "search_analyzer": "keyword"
        }
      }
    },
    "to": {
      "properties": {
        "domain": {
          "type": "text",
          "analyzer": "simple",
          "search_analyzer": "keyword"
        }
      }
    },
    "cc": {
      "properties": {
        "domain": {
          "type": "text",
          "analyzer": "simple",
          "search_analyzer": "keyword"
        }
      }
    },
    "bcc": {
      "properties": {
        "domain": {
          "type": "text",
          "analyzer": "simple",
          "search_analyzer": "keyword"
        }
      }
    }
  }
}'
```
